<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AnsibleDB2 - Live Demo Dashboard</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Roboto', sans-serif;
            background: #0b0c0e;
            color: #d8d9da;
        }

        .dashboard-header {
            background: #1a1d23;
            padding: 1rem 2rem;
            border-bottom: 1px solid #2d3139;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: 700;
            color: #5794f2;
        }

        .time-range {
            background: #2d3139;
            padding: 0.5rem 1rem;
            border-radius: 4px;
            color: #d8d9da;
            font-size: 0.875rem;
        }

        .nav-tabs {
            background: #1a1d23;
            padding: 0 2rem;
            display: flex;
            gap: 0.5rem;
            border-bottom: 1px solid #2d3139;
            overflow-x: auto;
        }

        .nav-tab {
            padding: 0.75rem 1.5rem;
            cursor: pointer;
            border: none;
            background: transparent;
            color: #8e9196;
            border-bottom: 2px solid transparent;
            transition: all 0.3s;
            white-space: nowrap;
        }

        .nav-tab:hover {
            color: #d8d9da;
        }

        .nav-tab.active {
            color: #5794f2;
            border-bottom-color: #5794f2;
        }

        .dashboard-content {
            padding: 2rem;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .stat-card {
            background: #1a1d23;
            padding: 1.5rem;
            border-radius: 4px;
            border: 1px solid #2d3139;
            transition: transform 0.2s;
        }

        .stat-card:hover {
            transform: translateY(-2px);
            border-color: #5794f2;
        }

        .stat-label {
            color: #8e9196;
            font-size: 0.875rem;
            margin-bottom: 0.5rem;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: 700;
            color: #d8d9da;
        }

        .stat-value.danger {
            color: #e02f44;
        }

        .stat-value.warning {
            color: #ff9830;
        }

        .stat-value.success {
            color: #73bf69;
        }

        .stat-subtext {
            font-size: 0.75rem;
            color: #8e9196;
            margin-top: 0.25rem;
        }

        .chart-container {
            background: #1a1d23;
            padding: 1.5rem;
            border-radius: 4px;
            border: 1px solid #2d3139;
            margin-bottom: 1.5rem;
        }

        .chart-title {
            color: #d8d9da;
            font-size: 1.125rem;
            margin-bottom: 1rem;
            font-weight: 500;
        }

        .chart {
            height: 300px;
            position: relative;
        }

        .bar-chart {
            display: flex;
            align-items: flex-end;
            justify-content: space-around;
            height: 100%;
            padding: 2rem 1rem 3rem;
        }

        .bar-wrapper {
            display: flex;
            flex-direction: column;
            align-items: center;
            flex: 1;
            max-width: 80px;
        }

        .bar {
            width: 100%;
            background: linear-gradient(180deg, #5794f2 0%, #3d71b8 100%);
            border-radius: 4px 4px 0 0;
            position: relative;
            transition: all 0.3s;
            cursor: pointer;
        }

        .bar:hover {
            background: linear-gradient(180deg, #6ea3ff 0%, #5794f2 100%);
        }

        .bar.danger {
            background: linear-gradient(180deg, #e02f44 0%, #b8233a 100%);
        }

        .bar.warning {
            background: linear-gradient(180deg, #ff9830 0%, #cc7a26 100%);
        }

        .bar.success {
            background: linear-gradient(180deg, #73bf69 0%, #5a9952 100%);
        }

        .bar-label {
            margin-top: 0.5rem;
            font-size: 0.75rem;
            color: #8e9196;
            text-align: center;
            word-wrap: break-word;
        }

        .bar-value {
            position: absolute;
            top: -25px;
            left: 50%;
            transform: translateX(-50%);
            font-size: 0.875rem;
            color: #d8d9da;
            font-weight: 600;
        }

        .table-container {
            background: #1a1d23;
            border-radius: 4px;
            border: 1px solid #2d3139;
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
        }

        th {
            background: #2d3139;
            padding: 1rem;
            text-align: left;
            color: #d8d9da;
            font-weight: 600;
            font-size: 0.875rem;
            white-space: nowrap;
        }

        td {
            padding: 1rem;
            border-top: 1px solid #2d3139;
            color: #8e9196;
            font-size: 0.875rem;
        }

        tr:hover {
            background: #23262e;
        }

        .badge {
            padding: 0.25rem 0.75rem;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            white-space: nowrap;
            display: inline-block;
        }

        .badge-danger {
            background: #e02f4420;
            color: #e02f44;
        }

        .badge-warning {
            background: #ff983020;
            color: #ff9830;
        }

        .badge-success {
            background: #73bf6920;
            color: #73bf69;
        }

        .badge-info {
            background: #5794f220;
            color: #5794f2;
        }

        .grid-2 {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 1.5rem;
        }

        .pie-chart-container {
            display: flex;
            align-items: stretch;
            justify-content: space-between;
            flex-direction: row;
            flex-wrap: wrap;
            gap: 1.5rem;
            height: 100%;
        }

        .pie-chart {
            position: relative;
            width: 200px;
            height: 200px;
            flex: 0 0 200px;
        }

        .legend {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 0.75rem;
            margin-top: 0;
            flex: 1;
        }

        .legend-item {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .legend-color {
            width: 16px;
            height: 16px;
            border-radius: 2px;
            flex-shrink: 0;
        }

        .legend-text {
            font-size: 0.875rem;
            color: #8e9196;
        }

        .world-map {
            height: 420px;
            border-radius: 4px;
            overflow: hidden;
        }

        #globalMap {
            height: 100%;
            width: 100%;
        }

        .leaflet-container {
            background: #0b0c0e;
        }

        .map-layout {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(260px, 1fr);
            gap: 1.5rem;
            margin-top: 1.5rem;
            align-items: stretch;
        }

        .map-legend {
            background: #121417;
            border: 1px solid #2d3139;
            border-radius: 4px;
            padding: 1rem;
            display: grid;
            gap: 0.75rem;
        }

        .map-legend-header {
            font-weight: 600;
            color: #d8d9da;
            font-size: 0.95rem;
        }

        .map-legend-item {
            display: grid;
            grid-template-columns: auto 1fr;
            gap: 0.75rem;
            align-items: start;
            padding: 0.5rem 0.25rem;
            border-bottom: 1px solid #1f2229;
        }

        .map-legend-item:last-child {
            border-bottom: none;
        }

        .map-status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            margin-top: 0.25rem;
            box-shadow: 0 0 6px rgba(0, 0, 0, 0.35);
        }

        .map-status-dot.fault {
            background: #ff4d4f;
            box-shadow: 0 0 8px rgba(255, 77, 79, 0.6);
        }

        .map-status-dot.warning {
            background: #ff9830;
            box-shadow: 0 0 8px rgba(255, 152, 48, 0.6);
        }

        .map-status-dot.healthy {
            background: #4ecdc4;
            box-shadow: 0 0 8px rgba(78, 205, 196, 0.6);
        }

        .map-status-dot.offline {
            background: #8e9196;
            box-shadow: 0 0 8px rgba(142, 145, 150, 0.6);
        }

        .map-status-dot.unknown {
            background: #4b5563;
            box-shadow: 0 0 8px rgba(75, 85, 99, 0.6);
        }

        .map-legend-name {
            color: #d8d9da;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .map-legend-meta {
            color: #8e9196;
            font-size: 0.8rem;
        }

        .map-legend-stats {
            display: flex;
            flex-wrap: wrap;
            gap: 0.75rem;
            font-size: 0.8rem;
            color: #8e9196;
            margin-top: 0.35rem;
        }

        .map-legend-stats .issues {
            color: #ff4d4f;
            font-weight: 600;
        }

        .map-legend-footer {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            padding-top: 0.5rem;
            border-top: 1px solid #1f2229;
            font-size: 0.75rem;
            color: #8e9196;
        }

        .map-legend-empty {
            color: #8e9196;
            font-size: 0.85rem;
        }

        .map-empty-state {
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100%;
            color: #8e9196;
            font-size: 0.9rem;
        }

        .map-popup {
            color: #1a1d23;
        }

        .map-popup-title {
            font-weight: 700;
            font-size: 1rem;
            margin-bottom: 0.25rem;
        }

        .map-popup-location {
            font-size: 0.85rem;
            color: #4b5563;
            margin-bottom: 0.75rem;
        }

        .map-popup-line {
            display: flex;
            justify-content: space-between;
            gap: 1.5rem;
            font-size: 0.85rem;
            margin-bottom: 0.35rem;
        }

        .map-popup-line span:first-child {
            color: #4b5563;
        }

        .map-popup-env {
            margin-top: 0.5rem;
            font-size: 0.8rem;
            color: #4b5563;
        }

        .map-popup-env span {
            display: inline-block;
            margin-right: 0.5rem;
            color: #1a1d23;
            font-weight: 600;
        }

        .os-overview {
            display: grid;
            grid-template-columns: minmax(0, 2fr) minmax(0, 1fr);
            gap: 1.5rem;
            margin-top: 1.5rem;
        }

        .os-list {
            background: #121417;
            border: 1px solid #2d3139;
            border-radius: 4px;
            padding: 1rem;
            display: flex;
            flex-direction: column;
            gap: 1rem;
            max-height: 300px;
            overflow-y: auto;
        }

        .os-list-item {
            display: flex;
            gap: 0.75rem;
            align-items: center;
        }

        .os-logo {
            width: 42px;
            height: 42px;
            border-radius: 50%;
            background: #1f232b;
            border: 1px solid #2d3139;
            display: flex;
            align-items: center;
            justify-content: center;
            overflow: hidden;
            flex-shrink: 0;
        }

        .os-logo img {
            width: 100%;
            height: 100%;
            object-fit: contain;
        }

        .os-logo.placeholder {
            background: linear-gradient(135deg, #667eea20, #764ba220);
            color: #d8d9da;
            font-weight: 600;
            font-size: 1rem;
        }

        .os-logo.placeholder span {
            color: inherit;
        }

        .os-list-details {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .os-name {
            color: #f1f2f4;
            font-weight: 600;
            font-size: 0.95rem;
        }

        .os-count {
            color: #8e9196;
            font-size: 0.85rem;
        }

        @media (max-width: 1024px) {
            .map-layout {
                grid-template-columns: 1fr;
            }

            .pie-chart-container {
                flex-direction: column;
            }

            .legend {
                margin-top: 1.5rem;
            }

            .os-overview {
                grid-template-columns: 1fr;
            }

            .os-list {
                max-height: none;
            }
        }

        @media (max-width: 768px) {
            .dashboard-content {
                padding: 1rem;
            }
            .grid-2 {
                grid-template-columns: 1fr;
            }
            .stats-grid {
                grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            }
            .map-legend {
                max-height: 260px;
                overflow-y: auto;
            }
            .map-legend-stats {
                flex-direction: column;
                gap: 0.35rem;
            }
            .pie-chart-container {
                align-items: center;
            }
        }
    </style>
</head>
<body>
    <div class="dashboard-header">
        <div class="logo">AnsibleDB2 Dashboard</div>
        <div class="time-range">Last updated: <span id="lastUpdate">Just now</span></div>
    </div>

    <div class="nav-tabs">
        <button class="nav-tab active" onclick="switchTab('overview', event)">Overview</button>
        <button class="nav-tab" onclick="switchTab('security', event)">Security &amp; Compliance</button>
        <button class="nav-tab" onclick="switchTab('infrastructure', event)">Infrastructure</button>
        <button class="nav-tab" onclick="switchTab('network', event)">Network Devices</button>
        <button class="nav-tab" onclick="switchTab('network-map', event)">Network Map</button>
        <button class="nav-tab" onclick="switchTab('agents', event)">Agent Status</button>
    </div>

    <div class="dashboard-content">
        <!-- Overview Tab -->
        <div id="overview" class="tab-content active">
            <div class="stats-grid" id="overviewStats"></div>
            <div class="chart-container">
                <div class="chart-title">Global Infrastructure &amp; Traffic</div>
                <div class="map-layout">
                    <div id="globalMap" class="world-map"></div>
                    <div class="map-legend" id="mapLegend"></div>
                </div>
            </div>
            <div class="grid-2">
                <div class="chart-container">
                    <div class="chart-title">Hosts by Operating System</div>
                    <div class="os-overview">
                        <div class="chart bar-chart" id="osChart"></div>
                        <div class="os-list" id="osList"></div>
                    </div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Infrastructure Distribution</div>
                    <div class="chart pie-chart-container">
                        <div class="pie-chart" id="infraPieChart"></div>
                        <div class="legend" id="infraLegend"></div>
                    </div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Recent Hosts Activity</div>
                <div class="table-container">
                    <table id="recentHostsTable"></table>
                </div>
            </div>
        </div>

        <!-- Security & Compliance Tab -->
        <div id="security" class="tab-content">
            <div class="stats-grid" id="securityStats"></div>
            <div class="grid-2">
                <div class="chart-container">
                    <div class="chart-title">CIS Benchmark Compliance by Level</div>
                    <div class="chart bar-chart" id="cisChart"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Patch Status Distribution</div>
                    <div class="chart bar-chart" id="patchChart"></div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Critical Compliance Issues</div>
                <div class="table-container">
                    <table id="complianceTable"></table>
                </div>
            </div>
        </div>

        <!-- Infrastructure Tab -->
        <div id="infrastructure" class="tab-content">
            <div class="stats-grid" id="infraStats"></div>
            <div class="grid-2">
                <div class="chart-container">
                    <div class="chart-title">Cloud Provider Distribution</div>
                    <div class="chart bar-chart" id="cloudChart"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Virtualization Types</div>
                    <div class="chart bar-chart" id="virtChart"></div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Infrastructure Details by Environment</div>
                <div class="table-container">
                    <table id="infraTable"></table>
                </div>
            </div>
        </div>

        <!-- Network Devices Tab -->
        <div id="network" class="tab-content">
            <div class="stats-grid" id="networkStats"></div>
            <div class="grid-2">
                <div class="chart-container">
                    <div class="chart-title">Network Devices by Vendor</div>
                    <div class="chart bar-chart" id="vendorChart"></div>
                </div>
                <div class="chart-container">
                    <div class="chart-title">Device Health Status</div>
                    <div class="chart bar-chart" id="firmwareChart"></div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Network Device Inventory</div>
                <div class="table-container">
                    <table id="networkTable"></table>
                </div>
            </div>
        </div>

        <!-- Network Map Tab -->
        <div id="network-map" class="tab-content">
            <div class="stats-grid" id="networkMapStats"></div>
            <div class="chart-container">
                <div class="chart-title">Global Network Device Status</div>
                <div class="map-layout">
                    <div id="networkMapView" class="world-map"></div>
                    <div class="map-legend" id="networkMapLegend"></div>
                </div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Active Network Alarms</div>
                <div class="table-container">
                    <table id="networkAlarmTable"></table>
                </div>
            </div>
        </div>

        <!-- Agents Tab -->
        <div id="agents" class="tab-content">
            <div class="stats-grid" id="agentStats"></div>
            <div class="chart-container">
                <div class="chart-title">Security Agent Status Across Fleet</div>
                <div class="chart bar-chart" id="agentStatusChart"></div>
            </div>
            <div class="chart-container">
                <div class="chart-title">Hosts with Agent Issues</div>
                <div class="table-container">
                    <table id="agentTable"></table>
                </div>
            </div>
        </div>
    </div>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script>
        window.dashboardInitialized = false;

        const OS_LOGOS = {
            'Rocky Linux': 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/rockylinux/rockylinux-original.svg',
            'SUSE Linux Enterprise': 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/suse/suse-original.svg',
            'Red Hat': 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/redhat/redhat-original.svg',
            'Ubuntu': 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/ubuntu/ubuntu-plain.svg',
            'Windows': 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/windows8/windows8-original.svg',
            'Debian': 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/debian/debian-original.svg',
            'Amazon Linux': 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/amazonwebservices/amazonwebservices-original.svg',
            'AlmaLinux': 'https://upload.wikimedia.org/wikipedia/commons/thumb/1/1b/AlmaLinux_logo.svg/256px-AlmaLinux_logo.svg.png',
            'Oracle Linux': 'https://upload.wikimedia.org/wikipedia/commons/thumb/5/50/Oracle_logo.svg/256px-Oracle_logo.svg.png',
            'Fedora': 'https://cdn.jsdelivr.net/gh/devicons/devicon/icons/fedora/fedora-original.svg'
        };

        function fetchJson(url) {
            return fetch(url).then(response => {
                if (!response.ok) {
                    throw new Error(`Failed to load ${url}: ${response.status} ${response.statusText}`);
                }
                return response.json();
            });
        }

        Promise.all([
            fetchJson('ansibledb2_facts_50_hosts.json'),
            fetchJson('ansibledb2_network_devices_30_with_locations.json')
        ])
            .then(([hostFacts, networkDevices]) => {
                initDashboard(hostFacts, networkDevices);
            })
            .catch(error => {
                console.error('Unable to load dashboard data, rendering empty state.', error);
                initDashboard([], []);
            });

        function initDashboard(hostFacts, networkDevices) {
            window.dashboardInitialized = true;
            const hosts = Array.isArray(hostFacts) ? hostFacts.map(normalizeHostRecord) : [];
            const devices = Array.isArray(networkDevices) ? networkDevices.map(normalizeNetworkDevice) : [];

            updateLastUpdated(hosts);

            // Render all tabs
            renderOverviewTab(hosts, devices);
            renderSecurityTab(hosts);
            renderInfrastructureTab(hosts);
            renderNetworkTab(devices);
            renderNetworkMapTab(devices);
            renderAgentsTab(hosts);
        }

        function normalizeHostRecord(raw) {
            const hostId = raw.host_id || raw.identity?.host_id || raw.identity?.fqdn || raw.identity?.hostname || 'unknown-host';
            const lastSeen = raw.last_seen || raw.collection_timestamp || raw.run_metadata?.collected_at || null;

            const hardware = { ...(raw.hardware || {}) };
            if (hardware.memory_gb === undefined) {
                const memoryMb = Number(hardware.memory_mb);
                if (Number.isFinite(memoryMb)) {
                    hardware.memory_gb = Math.round((memoryMb / 1024) * 10) / 10;
                }
            }
            if (!hardware.virtualization && raw.identity?.platform) {
                hardware.virtualization = raw.identity.platform;
            }

            const cloud = raw.cloud_metadata || raw.cloud || null;
            const datacenter = raw.datacenter || null;
            const provider = cloud?.provider || (datacenter ? 'OnPrem' : 'Unknown');
            const region = cloud?.region || cloud?.availability_zone || null;
            const instanceId = cloud?.instance_id || cloud?.resource_id || null;

            const inventory = raw.inventory_vars || raw.inventory || {};
            const environmentValue = (inventory.environment || inventory.env || 'unknown').toLowerCase();
            const normalizedEnvironment = environmentValue || 'unknown';
            const tags = {
                Environment: normalizedEnvironment.toUpperCase(),
                Application: inventory.app || inventory.application || 'N/A',
                Owner: inventory.owner || inventory.contact || 'N/A',
                Role: inventory.role || 'N/A',
                Tier: inventory.tier || 'N/A'
            };

            const compliance = raw.compliance || {};
            const patchStatus = compliance.patch_status || {};
            const cisScore = Number(compliance.cis_score);

            const securityAgentKeys = ['crowdstrike', 'qualys', 'splunk_universal_forwarder', 'osquery', 'custom_compliance_agent'];
            const normalizedAgents = securityAgentKeys.reduce((acc, key) => {
                const agent = raw.security_agents?.[key] || {};
                acc[key] = {
                    status: agent.status || 'unknown',
                    version: agent.version || agent.installed_version || 'n/a'
                };
                return acc;
            }, {});

            return {
                host_id: hostId,
                collection_timestamp: raw.collection_timestamp || lastSeen || raw.run_metadata?.collected_at || new Date().toISOString(),
                last_seen: lastSeen || raw.run_metadata?.collected_at || new Date().toISOString(),
                os: raw.os || {},
                hardware,
                cloud_metadata: {
                    provider,
                    region,
                    instance_id: instanceId,
                    tags
                },
                compliance: {
                    patch_status: {
                        critical: patchStatus.critical || 'compliant',
                        high: patchStatus.high || 'compliant',
                        medium: patchStatus.medium || 'compliant',
                        low: patchStatus.low || 'compliant'
                    },
                    cis_benchmark: {
                        level_1: deriveCisStatus(cisScore, 1),
                        level_2: deriveCisStatus(cisScore, 2)
                    },
                    cis_profile: compliance.cis_profile || 'CIS',
                    cis_score: Number.isFinite(cisScore) ? cisScore : null
                },
                vulnerabilities: raw.vulnerabilities || {},
                derived: raw.derived || {},
                services: Array.isArray(raw.services) ? raw.services : [],
                security_agents: normalizedAgents,
                inventory_vars: {
                    ...inventory,
                    environment: normalizedEnvironment
                },
                location: raw.location || (datacenter ? {
                    city: datacenter.city || 'Unknown',
                    country: datacenter.country || 'Unknown',
                    latitude: datacenter.latitude,
                    longitude: datacenter.longitude
                } : null),
                datacenter,
                run_metadata: raw.run_metadata || {}
            };
        }

        function deriveCisStatus(score, level) {
            if (!Number.isFinite(score)) {
                return 'unknown';
            }
            const passThreshold = level === 1 ? 90 : 85;
            const warnThreshold = level === 1 ? 75 : 70;

            if (score >= passThreshold) return 'pass';
            if (score >= warnThreshold) return 'partial';
            return 'fail';
        }

        function normalizeNetworkDevice(raw) {
            const alarms = Array.isArray(raw.alarms) ? raw.alarms : [];
            const protocols = raw.routing?.protocols || raw.routing_protocols || [];
            const location = raw.location || {};

            return {
                device_id: raw.device_id || raw.hostname || 'unknown-device',
                hostname: raw.hostname || raw.device_id || 'unknown-device',
                vendor: raw.vendor || 'Unknown',
                os: raw.os || 'Unknown',
                os_version: raw.os_version || raw.version || 'Unknown',
                model: raw.model || 'Unknown',
                status: raw.status || 'unknown',
                health: raw.health || 'unknown',
                compliance: raw.compliance || {},
                system: raw.system || {},
                management: raw.management || {},
                interfaces: Array.isArray(raw.interfaces) ? raw.interfaces : [],
                routing_protocols: protocols,
                vlans: raw.vlans || [],
                location,
                alarms,
                collection_timestamp: raw.collection_timestamp || raw.last_seen || new Date().toISOString(),
                last_seen: raw.last_seen || raw.collection_timestamp || new Date().toISOString()
            };
        }

        function switchTab(tabName, evt) {
            document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.nav-tab').forEach(t => t.classList.remove('active'));
            document.getElementById(tabName).classList.add('active');
            const target = evt && evt.currentTarget ? evt.currentTarget : (typeof event !== 'undefined' ? event.currentTarget : null);
            if (target) {
                target.classList.add('active');
            }
            if (tabName === 'overview' && window.globalMapInstance) {
                setTimeout(() => window.globalMapInstance.invalidateSize(), 200);
            }
            if (tabName === 'network-map' && window.networkMapInstance) {
                setTimeout(() => window.networkMapInstance.invalidateSize(), 200);
            }
        }

        function renderOverviewTab(hosts, devices) {
            // Calculate stats
            const totalHosts = hosts.length;
            const totalDevices = devices.length;

            const criticalPatches = hosts.filter(h => h.compliance.patch_status.critical === 'outdated').length;
            const cisNonCompliant = hosts.filter(h =>
                h.compliance.cis_benchmark.level_1 === 'fail' ||
                h.compliance.cis_benchmark.level_2 === 'fail'
            ).length;

            // Render stats
            const formatPercentage = (part, total) => {
                if (!total) return '0.0';
                return ((part / total) * 100).toFixed(1);
            };

            document.getElementById('overviewStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Hosts</div>
                    <div class="stat-value">${totalHosts}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Network Devices</div>
                    <div class="stat-value">${totalDevices}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Critical Patch Issues</div>
                    <div class="stat-value danger">${criticalPatches}</div>
                    <div class="stat-subtext">${formatPercentage(criticalPatches, totalHosts)}% of fleet</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">CIS Non-Compliant</div>
                    <div class="stat-value warning">${cisNonCompliant}</div>
                    <div class="stat-subtext">${formatPercentage(cisNonCompliant, totalHosts)}% of fleet</div>
                </div>
            `;

            // OS Distribution
            const osCounts = {};
            hosts.forEach(h => {
                const osKey = h.os.name;
                osCounts[osKey] = (osCounts[osKey] || 0) + 1;
            });

            const osData = Object.entries(osCounts)
                .map(([name, count]) => ({
                    rawName: name,
                    label: name.replace(' Enterprise Linux', '').replace(' Server', ''),
                    value: count
                }))
                .sort((a, b) => b.value - a.value);

            renderBarChart('osChart', osData);
            renderOsList('osList', osData);

            // Infrastructure pie chart
            const infraCounts = {};
            hosts.forEach(h => {
                const provider = h.cloud_metadata.provider;
                infraCounts[provider] = (infraCounts[provider] || 0) + 1;
            });

            renderPieChart('infraPieChart', 'infraLegend', Object.entries(infraCounts).map(([name, count]) => ({
                name,
                count,
                color: getProviderColor(name)
            })));

            // Recent hosts table
            const recentHosts = hosts.slice().sort((a, b) =>
                new Date(b.last_seen) - new Date(a.last_seen)
            ).slice(0, 10);

            document.getElementById('recentHostsTable').innerHTML = `
                <thead>
                    <tr>
                        <th>Host</th>
                        <th>OS</th>
                        <th>Provider</th>
                        <th>Last Seen</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${recentHosts.map(h => `
                        <tr>
                            <td>${h.host_id}</td>
                            <td>${h.os.name} ${h.os.version}</td>
                            <td>${h.cloud_metadata.provider}</td>
                            <td>${formatTimestamp(h.last_seen)}</td>
                            <td>${getBadgeForHost(h)}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;

            renderWorldMap(hosts);
        }

        function renderWorldMap(hostFacts = []) {
            const mapContainer = document.getElementById('globalMap');
            const legendContainer = document.getElementById('mapLegend');
            if (!mapContainer || !legendContainer) {
                return;
            }

            const aggregated = aggregateLocationData(hostFacts);

            if (!aggregated.length) {
                if (window.globalMapInstance) {
                    window.globalMapInstance.remove();
                    window.globalMapInstance = null;
                }
                mapContainer.innerHTML = '<div class="map-empty-state">No location data available.</div>';
                legendContainer.innerHTML = '<div class="map-legend-empty">No location data available.</div>';
                return;
            }

            if (typeof L === 'undefined') {
                mapContainer.innerHTML = '<div class="map-empty-state">Map library failed to load.</div>';
                legendContainer.innerHTML = '<div class="map-legend-empty">Map library failed to load.</div>';
                return;
            }

            if (window.globalMapInstance) {
                window.globalMapInstance.remove();
                window.globalMapInstance = null;
            }

            mapContainer.innerHTML = '';
            legendContainer.innerHTML = '';

            const severityOrder = { fault: 0, warning: 1, healthy: 2 };
            aggregated.sort((a, b) => {
                const severityDiff = severityOrder[a.status] - severityOrder[b.status];
                if (severityDiff !== 0) return severityDiff;
                return b.hostCount - a.hostCount;
            });

            const map = L.map('globalMap', {
                worldCopyJump: true,
                zoomControl: true,
                attributionControl: false,
                minZoom: 2
            });
            window.globalMapInstance = map;

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            const statusColors = {
                fault: '#ff4d4f',
                warning: '#ff9830',
                healthy: '#4ecdc4'
            };

            const bounds = [];

            aggregated.forEach(group => {
                const color = statusColors[group.status] || statusColors.healthy;
                const radius = Math.min(22, 8 + Math.sqrt(group.hostCount) * 2);
                const marker = L.circleMarker([group.latitude, group.longitude], {
                    radius,
                    color,
                    weight: 2,
                    fillColor: color,
                    fillOpacity: 0.75
                }).addTo(map);

                marker.bindTooltip(`${group.name} • ${group.hostCount} hosts`, { direction: 'top' });
                marker.bindPopup(createMapPopup(group));

                bounds.push([group.latitude, group.longitude]);
            });

            if (bounds.length > 1) {
                map.fitBounds(bounds, { padding: [40, 40], maxZoom: 5 });
            } else if (bounds.length === 1) {
                map.setView(bounds[0], 4);
            } else {
                map.setView([20, 0], 2);
            }

            const statusDescriptions = {
                fault: 'Fault detected',
                warning: 'Needs attention',
                healthy: 'Healthy'
            };

            legendContainer.innerHTML = `
                <div class="map-legend-header">Data Centers &amp; Cloud Regions</div>
                ${aggregated.map(group => {
                    const envSummary = formatEnvironmentSummary(group.environments);
                    const traffic = Math.round(group.traffic).toLocaleString();
                    const issuesLabel = group.issues ? `${group.issues} issue${group.issues > 1 ? 's' : ''}` : statusDescriptions[group.status];
                    return `
                        <div class="map-legend-item">
                            <span class="map-status-dot ${group.status}"></span>
                            <div>
                                <div class="map-legend-name">${group.name}</div>
                                <div class="map-legend-meta">${group.provider}${group.provider && (group.city || group.country) ? ' • ' : ''}${group.city}, ${group.country}</div>
                                <div class="map-legend-stats">
                                    <span>${group.hostCount} hosts</span>
                                    <span>${traffic} Mbps</span>
                                    <span class="${group.issues ? 'issues' : ''}">${issuesLabel}</span>
                                </div>
                                ${envSummary ? `<div class="map-legend-meta">${envSummary}</div>` : ''}
                            </div>
                        </div>
                    `;
                }).join('')}
                <div class="map-legend-footer">
                    ${Object.entries(statusDescriptions).map(([status, label]) => `<span><span class="map-status-dot ${status}"></span>${label}</span>`).join('')}
                </div>
            `;

            setTimeout(() => map.invalidateSize(), 200);
        }

        function aggregateLocationData(hostFacts) {
            if (!Array.isArray(hostFacts)) {
                return [];
            }

            const groups = {};

            hostFacts.forEach(host => {
                if (!host || !host.location) {
                    return;
                }
                const { latitude, longitude, city, country } = host.location;
                const lat = Number(latitude);
                const lng = Number(longitude);
                if (!Number.isFinite(lat) || !Number.isFinite(lng)) {
                    return;
                }

                const datacenterName = host.datacenter && host.datacenter.datacenter ? host.datacenter.datacenter : null;
                const provider = host.cloud && host.cloud.provider ? host.cloud.provider : (datacenterName ? 'On-Prem' : 'Unknown');
                const region = host.cloud && host.cloud.region ? host.cloud.region : '';
                const name = datacenterName || (provider && provider !== 'On-Prem' && region ? `${provider} ${region}` : `${city || 'Unknown'}, ${country || 'Unknown'}`);
                const key = `${name}:${lat}:${lng}`;

                if (!groups[key]) {
                    groups[key] = {
                        name,
                        provider,
                        city: city || 'Unknown',
                        country: country || 'Unknown',
                        latitude: lat,
                        longitude: lng,
                        hostCount: 0,
                        issues: 0,
                        warnings: 0,
                        traffic: 0,
                        riskTotal: 0,
                        environments: {}
                    };
                }

                const group = groups[key];
                group.hostCount += 1;
                group.traffic += estimateTraffic(host);
                const riskScore = Number(host.derived && host.derived.risk_score) || 0;
                group.riskTotal += riskScore;

                const environment = (host.inventory_vars && host.inventory_vars.environment ? host.inventory_vars.environment : 'unknown').toLowerCase();
                group.environments[environment] = (group.environments[environment] || 0) + 1;

                const health = evaluateHostHealth(host);
                if (health === 'fault') {
                    group.issues += 1;
                } else if (health === 'warning') {
                    group.warnings += 1;
                }
            });

            return Object.values(groups).map(group => {
                const avgRisk = group.hostCount ? group.riskTotal / group.hostCount : 0;
                let status = 'healthy';
                if (group.issues > 0) {
                    status = 'fault';
                } else if (group.warnings > 0 || avgRisk >= 65) {
                    status = 'warning';
                }
                return {
                    ...group,
                    status,
                    averageRisk: avgRisk
                };
            });
        }

        function evaluateHostHealth(host) {
            const patchStatus = host.compliance && host.compliance.patch_status ? host.compliance.patch_status : {};
            const criticalIssue = ['outdated', 'failed'].includes(patchStatus.critical);
            const highIssue = ['outdated', 'failed'].includes(patchStatus.high);

            const agentStatuses = host.security_agents ? Object.values(host.security_agents) : [];
            const agentFault = agentStatuses.some(agent => ['stopped', 'failed', 'error', 'drift_detected'].includes(agent.status));
            const agentWarning = agentStatuses.some(agent => ['degraded', 'starting'].includes(agent.status));

            const serviceIssues = Array.isArray(host.services) ? host.services.some(service => service.enabled && service.state !== 'running') : false;

            const riskScore = Number(host.derived && host.derived.risk_score) || 0;

            if (criticalIssue || agentFault || riskScore >= 80) {
                return 'fault';
            }

            if (highIssue || agentWarning || serviceIssues || riskScore >= 65) {
                return 'warning';
            }

            return 'healthy';
        }

        function estimateTraffic(host) {
            const runningServices = Array.isArray(host.services) ? host.services.filter(service => service.state === 'running').length : 0;
            const cores = Number(host.hardware && host.hardware.cpu_cores) || 0;
            const internetBoost = host.derived && host.derived.internet_facing ? 80 : 40;
            return internetBoost + runningServices * 6 + cores * 1.5;
        }

        function formatEnvironmentSummary(environments) {
            const entries = Object.entries(environments || {});
            if (!entries.length) {
                return '';
            }
            return entries
                .map(([env, count]) => `${env.toUpperCase()} (${count})`)
                .join(' · ');
        }

        function createMapPopup(group) {
            const traffic = Math.round(group.traffic).toLocaleString();
            const envSummary = Object.entries(group.environments || {})
                .map(([env, count]) => `<span>${env.toUpperCase()} (${count})</span>`)
                .join('');
            return `
                <div class="map-popup">
                    <div class="map-popup-title">${group.name}</div>
                    <div class="map-popup-location">${group.city}, ${group.country}</div>
                    <div class="map-popup-line"><span>Provider</span><span>${group.provider}</span></div>
                    <div class="map-popup-line"><span>Hosts</span><span>${group.hostCount}</span></div>
                    <div class="map-popup-line"><span>Estimated Traffic</span><span>${traffic} Mbps</span></div>
                    <div class="map-popup-line"><span>Open Issues</span><span>${group.issues}</span></div>
                    ${envSummary ? `<div class="map-popup-env">${envSummary}</div>` : ''}
                </div>
            `;
        }

        window.addEventListener('resize', () => {
            if (window.globalMapInstance) {
                window.globalMapInstance.invalidateSize();
            }
            if (window.networkMapInstance) {
                window.networkMapInstance.invalidateSize();
            }
        });

        function renderSecurityTab(hosts) {
            const totalHosts = hosts.length;
            const criticalOutdated = hosts.filter(h => h.compliance.patch_status.critical === 'outdated').length;
            const highOutdated = hosts.filter(h => h.compliance.patch_status.high === 'outdated').length;
            const cisLevel1Fail = hosts.filter(h => h.compliance.cis_benchmark.level_1 === 'fail').length;
            const cisLevel2Fail = hosts.filter(h => h.compliance.cis_benchmark.level_2 === 'fail').length;

            document.getElementById('securityStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Critical Patches Needed</div>
                    <div class="stat-value danger">${criticalOutdated}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">High Priority Patches</div>
                    <div class="stat-value warning">${highOutdated}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">CIS Level 1 Failures</div>
                    <div class="stat-value danger">${cisLevel1Fail}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">CIS Level 2 Failures</div>
                    <div class="stat-value warning">${cisLevel2Fail}</div>
                </div>
            `;

            // CIS Benchmark chart
            const cisData = {
                'Level 1 Pass': hosts.filter(h => h.compliance.cis_benchmark.level_1 === 'pass').length,
                'Level 1 Partial': hosts.filter(h => h.compliance.cis_benchmark.level_1 === 'partial').length,
                'Level 1 Fail': cisLevel1Fail,
                'Level 2 Pass': hosts.filter(h => h.compliance.cis_benchmark.level_2 === 'pass').length,
                'Level 2 Partial': hosts.filter(h => h.compliance.cis_benchmark.level_2 === 'partial').length,
                'Level 2 Fail': cisLevel2Fail
            };

            renderBarChart('cisChart', Object.entries(cisData).map(([label, value]) => ({
                label,
                value,
                class: label.includes('Fail') ? 'danger' : label.includes('Partial') ? 'warning' : 'success'
            })));

            // Patch status chart
            const patchData = {
                'Critical Compliant': hosts.filter(h => h.compliance.patch_status.critical === 'compliant').length,
                'Critical Outdated': criticalOutdated,
                'High Compliant': hosts.filter(h => h.compliance.patch_status.high === 'compliant').length,
                'High Outdated': highOutdated
            };

            renderBarChart('patchChart', Object.entries(patchData).map(([label, value]) => ({
                label,
                value,
                class: label.includes('Outdated') ? 'danger' : 'success'
            })));

            // Compliance issues table
            const issueHosts = hosts.filter(h => 
                h.compliance.cis_benchmark.level_1 === 'fail' || 
                h.compliance.patch_status.critical === 'outdated'
            ).slice(0, 15);

            document.getElementById('complianceTable').innerHTML = `
                <thead>
                    <tr>
                        <th>Host</th>
                        <th>OS</th>
                        <th>CIS L1</th>
                        <th>CIS L2</th>
                        <th>Critical Patches</th>
                        <th>High Patches</th>
                    </tr>
                </thead>
                <tbody>
                    ${issueHosts.map(h => `
                        <tr>
                            <td>${h.host_id}</td>
                            <td>${h.os.name}</td>
                            <td><span class="badge badge-${h.compliance.cis_benchmark.level_1 === 'pass' ? 'success' : 'danger'}">${h.compliance.cis_benchmark.level_1}</span></td>
                            <td><span class="badge badge-${h.compliance.cis_benchmark.level_2 === 'pass' ? 'success' : 'danger'}">${h.compliance.cis_benchmark.level_2}</span></td>
                            <td><span class="badge badge-${h.compliance.patch_status.critical === 'compliant' ? 'success' : 'danger'}">${h.compliance.patch_status.critical}</span></td>
                            <td><span class="badge badge-${h.compliance.patch_status.high === 'compliant' ? 'success' : 'warning'}">${h.compliance.patch_status.high}</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
        }

        function renderInfrastructureTab(hosts) {
            const providers = {};
            hosts.forEach(h => {
                const p = h.cloud_metadata.provider;
                providers[p] = (providers[p] || 0) + 1;
            });

            const virts = {};
            hosts.forEach(h => {
                const v = h.hardware.virtualization;
                virts[v] = (virts[v] || 0) + 1;
            });

            const envs = {};
            hosts.forEach(h => {
                const env = h.cloud_metadata.tags.Environment;
                envs[env] = (envs[env] || 0) + 1;
            });

            document.getElementById('infraStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">On-Premise</div>
                    <div class="stat-value">${providers['OnPrem'] || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">AWS</div>
                    <div class="stat-value">${providers['AWS'] || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Azure</div>
                    <div class="stat-value">${providers['Azure'] || 0}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">GCP</div>
                    <div class="stat-value">${providers['GCP'] || 0}</div>
                </div>
            `;

            renderBarChart('cloudChart', Object.entries(providers).map(([label, value]) => ({ label, value })));
            renderBarChart('virtChart', Object.entries(virts).map(([label, value]) => ({ label, value })));

            document.getElementById('infraTable').innerHTML = `
                <thead>
                    <tr>
                        <th>Host</th>
                        <th>Environment</th>
                        <th>Provider</th>
                        <th>Virtualization</th>
                        <th>CPU Cores</th>
                        <th>Memory</th>
                    </tr>
                </thead>
                <tbody>
                    ${hosts.map(h => `
                        <tr>
                            <td>${h.host_id}</td>
                            <td><span class="badge badge-info">${h.cloud_metadata.tags.Environment}</span></td>
                            <td>${h.cloud_metadata.provider}</td>
                            <td>${h.hardware.virtualization}</td>
                            <td>${h.hardware.cpu_cores}</td>
                            <td>${Number.isFinite(Number(h.hardware.memory_gb)) ? `${Number(h.hardware.memory_gb)} GB` : '—'}</td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
        }

        function renderNetworkTab(devices) {
            const vendors = {};
            devices.forEach(d => {
                vendors[d.vendor] = (vendors[d.vendor] || 0) + 1;
            });

            const healthCounts = {};
            devices.forEach(d => {
                const health = (d.health || 'unknown').toLowerCase();
                healthCounts[health] = (healthCounts[health] || 0) + 1;
            });

            const online = devices.filter(d => d.status === 'online').length;
            const offline = devices.filter(d => d.status !== 'online').length;
            const critical = devices.filter(d => d.health === 'critical').length;
            const degraded = devices.filter(d => d.health === 'degraded').length;

            const auditScores = devices
                .map(d => Number(d.compliance?.audit_score))
                .filter(score => Number.isFinite(score));
            const averageAudit = auditScores.length
                ? (auditScores.reduce((sum, score) => sum + score, 0) / auditScores.length).toFixed(1)
                : 'N/A';

            document.getElementById('networkStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Devices</div>
                    <div class="stat-value">${devices.length}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Online</div>
                    <div class="stat-value success">${online}</div>
                    <div class="stat-subtext">${((online / Math.max(devices.length, 1)) * 100).toFixed(1)}% availability</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Degraded / Critical</div>
                    <div class="stat-value warning">${degraded + critical}</div>
                    <div class="stat-subtext">${critical} critical, ${degraded} degraded</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Avg. Compliance Score</div>
                    <div class="stat-value">${averageAudit}</div>
                    <div class="stat-subtext">Based on latest network audits</div>
                </div>
            `;

            renderBarChart('vendorChart', Object.entries(vendors).map(([label, value]) => ({ label, value })));
            renderBarChart('firmwareChart', Object.entries(healthCounts).map(([label, value]) => ({
                label: label.toUpperCase(),
                value,
                class: label === 'critical' ? 'danger' : label === 'degraded' ? 'warning' : label === 'ok' ? 'success' : 'info'
            })));

            document.getElementById('networkTable').innerHTML = `
                <thead>
                    <tr>
                        <th>Device</th>
                        <th>Vendor</th>
                        <th>OS</th>
                        <th>Version</th>
                        <th>Model</th>
                        <th>Status</th>
                        <th>Health</th>
                        <th>Audit Score</th>
                        <th>Active Alarms</th>
                    </tr>
                </thead>
                <tbody>
                    ${devices.map(d => {
                        const statusClass = d.status === 'online' ? 'success' : d.status === 'offline' ? 'danger' : 'warning';
                        const healthClass = d.health === 'critical' ? 'danger' : d.health === 'degraded' ? 'warning' : d.health === 'ok' ? 'success' : 'info';
                        const alarmCount = d.alarms ? d.alarms.length : 0;
                        const auditScore = Number.isFinite(Number(d.compliance?.audit_score)) ? Number(d.compliance.audit_score) : '—';
                        return `
                            <tr>
                                <td>${d.hostname}</td>
                                <td>${d.vendor}</td>
                                <td>${d.os}</td>
                                <td>${d.os_version}</td>
                                <td>${d.model}</td>
                                <td><span class="badge badge-${statusClass}">${d.status}</span></td>
                                <td><span class="badge badge-${healthClass}">${d.health}</span></td>
                                <td>${auditScore === '—' ? '—' : auditScore}</td>
                                <td>${alarmCount}</td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            `;
        }

        function renderNetworkMapTab(devices) {
            const statsContainer = document.getElementById('networkMapStats');
            const mapContainer = document.getElementById('networkMapView');
            const legendContainer = document.getElementById('networkMapLegend');
            if (!statsContainer || !mapContainer || !legendContainer) {
                return;
            }

            const total = devices.length;
            const online = devices.filter(d => d.status === 'online').length;
            const offline = total - online;
            const critical = devices.filter(d => d.health === 'critical').length;
            const alarms = devices.reduce((sum, d) => sum + (Array.isArray(d.alarms) ? d.alarms.length : 0), 0);

            statsContainer.innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Network Devices</div>
                    <div class="stat-value">${total}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Online</div>
                    <div class="stat-value success">${online}</div>
                    <div class="stat-subtext">${((online / Math.max(total, 1)) * 100).toFixed(1)}% availability</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Offline</div>
                    <div class="stat-value danger">${offline}</div>
                    <div class="stat-subtext">${critical} critical health events</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Active Alarms</div>
                    <div class="stat-value warning">${alarms}</div>
                    <div class="stat-subtext">Across all monitored devices</div>
                </div>
            `;

            const locatedDevices = devices.filter(d => {
                const lat = Number(d.location?.latitude);
                const lng = Number(d.location?.longitude);
                return Number.isFinite(lat) && Number.isFinite(lng);
            });

            if (!locatedDevices.length) {
                if (window.networkMapInstance) {
                    window.networkMapInstance.remove();
                    window.networkMapInstance = null;
                }
                mapContainer.innerHTML = '<div class="map-empty-state">No network location data available.</div>';
                legendContainer.innerHTML = '<div class="map-legend-empty">No location data available.</div>';
                renderNetworkAlarmTable(devices);
                return;
            }

            if (typeof L === 'undefined') {
                mapContainer.innerHTML = '<div class="map-empty-state">Map library failed to load.</div>';
                legendContainer.innerHTML = '<div class="map-legend-empty">Map library failed to load.</div>';
                renderNetworkAlarmTable(devices);
                return;
            }

            if (window.networkMapInstance) {
                window.networkMapInstance.remove();
                window.networkMapInstance = null;
            }

            mapContainer.innerHTML = '';
            legendContainer.innerHTML = '';

            const map = L.map('networkMapView', {
                worldCopyJump: true,
                zoomControl: true,
                attributionControl: false,
                minZoom: 2
            });
            window.networkMapInstance = map;

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                subdomains: 'abcd',
                maxZoom: 19
            }).addTo(map);

            const statusColors = {
                critical: '#ff4d4f',
                degraded: '#ff9830',
                ok: '#4ecdc4',
                offline: '#8e9196',
                unknown: '#4b5563'
            };

            const statusClass = {
                critical: 'fault',
                degraded: 'warning',
                ok: 'healthy',
                offline: 'offline',
                unknown: 'unknown'
            };

            const bounds = [];
            const statusSummary = { critical: 0, degraded: 0, ok: 0, offline: 0, unknown: 0 };

            locatedDevices.forEach(device => {
                const healthKey = getNetworkHealthKey(device);
                statusSummary[healthKey] = (statusSummary[healthKey] || 0) + 1;
                const color = statusColors[healthKey] || statusColors.unknown;
                const marker = L.circleMarker([device.location.latitude, device.location.longitude], {
                    radius: 9,
                    color,
                    weight: 2,
                    fillColor: color,
                    fillOpacity: 0.8
                }).addTo(map);

                marker.bindTooltip(`${device.hostname} • ${device.vendor}`, { direction: 'top' });
                marker.bindPopup(createNetworkMapPopup(device));

                bounds.push([device.location.latitude, device.location.longitude]);
            });

            if (bounds.length > 1) {
                map.fitBounds(bounds, { padding: [40, 40], maxZoom: 5 });
            } else if (bounds.length === 1) {
                map.setView(bounds[0], 5);
            } else {
                map.setView([20, 0], 2);
            }

            const legendEntries = [
                { key: 'critical', label: 'Critical Health', className: statusClass.critical },
                { key: 'degraded', label: 'Degraded', className: statusClass.degraded },
                { key: 'ok', label: 'Healthy', className: statusClass.ok },
                { key: 'offline', label: 'Offline', className: statusClass.offline },
                { key: 'unknown', label: 'Unknown', className: statusClass.unknown }
            ];

            legendContainer.innerHTML = `
                <div class="map-legend-header">Network Device Status</div>
                ${legendEntries.map(entry => `
                    <div class="map-legend-item">
                        <span class="map-status-dot ${entry.className}"></span>
                        <div>
                            <div class="map-legend-name">${entry.label}</div>
                            <div class="map-legend-meta">${statusSummary[entry.key] || 0} devices</div>
                        </div>
                    </div>
                `).join('')}
            `;

            renderNetworkAlarmTable(devices);
        }

        function getNetworkHealthKey(device) {
            if (device.status === 'offline') {
                return 'offline';
            }
            const health = (device.health || '').toLowerCase();
            if (health === 'critical') return 'critical';
            if (health === 'degraded') return 'degraded';
            if (health === 'ok' || health === 'healthy') return 'ok';
            return 'unknown';
        }

        function createNetworkMapPopup(device) {
            const location = device.location || {};
            const protocols = Array.isArray(device.routing_protocols) && device.routing_protocols.length
                ? device.routing_protocols.join(', ')
                : '—';
            const alarmCount = Array.isArray(device.alarms) ? device.alarms.length : 0;
            const alarmPreview = alarmCount ? device.alarms.slice(0, 2).map(alarm => {
                const severity = (alarm.severity || 'info').toUpperCase();
                return `<span>${severity}: ${alarm.message}</span>`;
            }).join('') : '';

            return `
                <div class="map-popup">
                    <div class="map-popup-title">${device.hostname}</div>
                    <div class="map-popup-location">${location.city || 'Unknown'}, ${location.country || 'Unknown'}</div>
                    <div class="map-popup-line"><span>Vendor</span><span>${device.vendor}</span></div>
                    <div class="map-popup-line"><span>Status</span><span>${device.status} • ${device.health}</span></div>
                    <div class="map-popup-line"><span>Protocols</span><span>${protocols}</span></div>
                    <div class="map-popup-line"><span>Alarms</span><span>${alarmCount}</span></div>
                    ${alarmPreview ? `<div class="map-popup-env">${alarmPreview}</div>` : ''}
                </div>
            `;
        }

        function renderNetworkAlarmTable(devices) {
            const table = document.getElementById('networkAlarmTable');
            if (!table) {
                return;
            }

            const alarms = [];
            devices.forEach(device => {
                (device.alarms || []).forEach(alarm => {
                    alarms.push({
                        device: device.hostname,
                        vendor: device.vendor,
                        severity: (alarm.severity || 'info').toLowerCase(),
                        code: alarm.code || '—',
                        message: alarm.message || '—',
                        status: device.status
                    });
                });
            });

            if (!alarms.length) {
                table.innerHTML = '<tbody><tr><td colspan="5">No active alarms</td></tr></tbody>';
                return;
            }

            const severityOrder = { critical: 0, major: 1, minor: 2, warning: 3, info: 4, notice: 5 };
            alarms.sort((a, b) => (severityOrder[a.severity] ?? 99) - (severityOrder[b.severity] ?? 99));

            table.innerHTML = `
                <thead>
                    <tr>
                        <th>Device</th>
                        <th>Severity</th>
                        <th>Code</th>
                        <th>Description</th>
                        <th>Status</th>
                    </tr>
                </thead>
                <tbody>
                    ${alarms.map(alarm => {
                        const badgeClass = getAlarmBadgeClass(alarm.severity);
                        const statusClass = alarm.status === 'online' ? 'success' : alarm.status === 'offline' ? 'danger' : 'warning';
                        return `
                            <tr>
                                <td>${alarm.device}</td>
                                <td><span class="badge badge-${badgeClass}">${alarm.severity.toUpperCase()}</span></td>
                                <td>${alarm.code}</td>
                                <td>${alarm.message}</td>
                                <td><span class="badge badge-${statusClass}">${alarm.status}</span></td>
                            </tr>
                        `;
                    }).join('')}
                </tbody>
            `;
        }

        function getAlarmBadgeClass(severity) {
            const normalized = (severity || '').toLowerCase();
            if (normalized === 'critical' || normalized === 'major') return 'danger';
            if (normalized === 'minor' || normalized === 'warning') return 'warning';
            if (normalized === 'info' || normalized === 'notice') return 'info';
            return 'info';
        }

        function renderAgentsTab(hosts) {
            const agents = ['crowdstrike', 'qualys', 'splunk_universal_forwarder', 'osquery', 'custom_compliance_agent'];
            const agentStats = {};

            agents.forEach(agent => {
                agentStats[agent] = {
                    healthy: 0,
                    running: 0,
                    stopped: 0,
                    drift_detected: 0
                };

                hosts.forEach(h => {
                    const status = h.security_agents[agent]?.status;
                    if (status && agentStats[agent][status] !== undefined) {
                        agentStats[agent][status]++;
                    }
                });
            });

            const totalIssues = hosts.reduce((sum, h) => {
                return sum + agents.filter(a => {
                    const status = h.security_agents[a]?.status;
                    return status === 'stopped' || status === 'drift_detected';
                }).length;
            }, 0);

            document.getElementById('agentStats').innerHTML = `
                <div class="stat-card">
                    <div class="stat-label">Total Agent Issues</div>
                    <div class="stat-value danger">${totalIssues}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Agents Stopped</div>
                    <div class="stat-value danger">${Object.values(agentStats).reduce((s, a) => s + a.stopped, 0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Drift Detected</div>
                    <div class="stat-value warning">${Object.values(agentStats).reduce((s, a) => s + a.drift_detected, 0)}</div>
                </div>
                <div class="stat-card">
                    <div class="stat-label">Healthy Agents</div>
                    <div class="stat-value success">${Object.values(agentStats).reduce((s, a) => s + a.healthy, 0)}</div>
                </div>
            `;

            // Agent status chart
            const agentChartData = [];
            Object.entries(agentStats).forEach(([agent, stats]) => {
                agentChartData.push({
                    label: agent.replace(/_/g, ' ').toUpperCase(),
                    value: stats.healthy + stats.running,
                    class: stats.stopped > 5 || stats.drift_detected > 5 ? 'danger' : stats.stopped > 0 || stats.drift_detected > 0 ? 'warning' : 'success'
                });
            });

            renderBarChart('agentStatusChart', agentChartData);

            // Hosts with issues
            const issueHosts = hosts.filter(h => {
                return agents.some(a => {
                    const status = h.security_agents[a]?.status;
                    return status === 'stopped' || status === 'drift_detected';
                });
            }).slice(0, 15);

            document.getElementById('agentTable').innerHTML = `
                <thead>
                    <tr>
                        <th>Host</th>
                        <th>CrowdStrike</th>
                        <th>Qualys</th>
                        <th>Splunk</th>
                        <th>Osquery</th>
                        <th>Compliance Agent</th>
                    </tr>
                </thead>
                <tbody>
                    ${issueHosts.map(h => `
                        <tr>
                            <td>${h.host_id}</td>
                            <td><span class="badge badge-${getAgentBadgeClass(h.security_agents.crowdstrike.status)}">${h.security_agents.crowdstrike.status}</span></td>
                            <td><span class="badge badge-${getAgentBadgeClass(h.security_agents.qualys.status)}">${h.security_agents.qualys.status}</span></td>
                            <td><span class="badge badge-${getAgentBadgeClass(h.security_agents.splunk_universal_forwarder.status)}">${h.security_agents.splunk_universal_forwarder.status}</span></td>
                            <td><span class="badge badge-${getAgentBadgeClass(h.security_agents.osquery.status)}">${h.security_agents.osquery.status}</span></td>
                            <td><span class="badge badge-${getAgentBadgeClass(h.security_agents.custom_compliance_agent.status)}">${h.security_agents.custom_compliance_agent.status}</span></td>
                        </tr>
                    `).join('')}
                </tbody>
            `;
        }

        function renderBarChart(containerId, data) {
            const container = document.getElementById(containerId);
            container.innerHTML = '';

            const maxValue = Math.max(1, ...data.map(d => d.value));
            
            data.forEach(item => {
                const wrapper = document.createElement('div');
                wrapper.className = 'bar-wrapper';
                
                const bar = document.createElement('div');
                bar.className = `bar ${item.class || ''}`;
                const height = (item.value / maxValue) * 80;
                bar.style.height = `${height}%`;
                
                const value = document.createElement('div');
                value.className = 'bar-value';
                value.textContent = item.value;
                
                const label = document.createElement('div');
                label.className = 'bar-label';
                label.textContent = item.label;
                
                bar.appendChild(value);
                wrapper.appendChild(bar);
                wrapper.appendChild(label);
                container.appendChild(wrapper);
            });
        }

        function renderOsList(containerId, data) {
            const container = document.getElementById(containerId);
            if (!container) {
                return;
            }

            container.innerHTML = data.map(item => {
                const logo = OS_LOGOS[item.rawName] || null;
                const countLabel = item.value === 1 ? '1 host' : `${item.value} hosts`;
                const logoContent = logo
                    ? `<img src="${logo}" alt="${item.rawName} logo" loading="lazy">`
                    : `<span>${item.rawName.charAt(0)}</span>`;

                return `
                    <div class="os-list-item">
                        <div class="os-logo ${logo ? '' : 'placeholder'}">${logoContent}</div>
                        <div class="os-list-details">
                            <span class="os-name">${item.rawName}</span>
                            <span class="os-count">${countLabel}</span>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function renderPieChart(chartId, legendId, data) {
            const total = data.reduce((sum, d) => sum + d.count, 0);
            const svg = document.createElementNS('http://www.w3.org/2000/svg', 'svg');
            svg.setAttribute('width', '200');
            svg.setAttribute('height', '200');
            svg.setAttribute('viewBox', '0 0 200 200');
            
            let currentAngle = 0;
            const centerX = 100;
            const centerY = 100;
            const radius = 80;
            
            data.forEach(item => {
                const percentage = item.count / total;
                const angle = percentage * 360;
                
                const startAngle = (currentAngle - 90) * Math.PI / 180;
                const endAngle = (currentAngle + angle - 90) * Math.PI / 180;
                
                const x1 = centerX + radius * Math.cos(startAngle);
                const y1 = centerY + radius * Math.sin(startAngle);
                const x2 = centerX + radius * Math.cos(endAngle);
                const y2 = centerY + radius * Math.sin(endAngle);
                
                const largeArc = angle > 180 ? 1 : 0;
                
                const path = document.createElementNS('http://www.w3.org/2000/svg', 'path');
                const pathData = `M ${centerX} ${centerY} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z`;
                path.setAttribute('d', pathData);
                path.setAttribute('fill', item.color);
                path.setAttribute('stroke', '#1a1d23');
                path.setAttribute('stroke-width', '2');
                
                svg.appendChild(path);
                currentAngle += angle;
            });
            
            document.getElementById(chartId).appendChild(svg);
            
            // Legend
            const legend = document.getElementById(legendId);
            legend.innerHTML = data.map(item => `
                <div class="legend-item">
                    <div class="legend-color" style="background: ${item.color}"></div>
                    <span class="legend-text">${item.name}: ${item.count} (${((item.count/total)*100).toFixed(1)}%)</span>
                </div>
            `).join('');
        }

        function getProviderColor(provider) {
            const colors = {
                'OnPrem': '#5794f2',
                'AWS': '#ff9830',
                'Azure': '#73bf69',
                'GCP': '#b877d9'
            };
            return colors[provider] || '#8e9196';
        }

        function getBadgeForHost(host) {
            const critical = host.compliance.patch_status.critical === 'outdated';
            const cisFail = host.compliance.cis_benchmark.level_1 === 'fail';
            
            if (critical || cisFail) {
                return '<span class="badge badge-danger">Critical</span>';
            } else if (host.compliance.patch_status.high === 'outdated') {
                return '<span class="badge badge-warning">Warning</span>';
            } else {
                return '<span class="badge badge-success">Healthy</span>';
            }
        }

        function getAgentBadgeClass(status) {
            if (status === 'stopped') return 'danger';
            if (status === 'drift_detected') return 'warning';
            if (status === 'healthy') return 'success';
            return 'info';
        }

        function formatTimestamp(ts) {
            const date = new Date(ts);
            const now = new Date();
            const diff = Math.floor((now - date) / 1000 / 60);
            
            if (diff < 1) return 'Just now';
            if (diff < 60) return `${diff} min ago`;
            if (diff < 1440) return `${Math.floor(diff / 60)} hr ago`;
            return `${Math.floor(diff / 1440)} days ago`;
        }

        function updateLastUpdated(hosts) {
            const lastUpdateElement = document.getElementById('lastUpdate');
            if (!hosts.length) {
                lastUpdateElement.textContent = 'Awaiting data';
                return;
            }

            const latestTimestamp = hosts.reduce((latest, host) => {
                const timestamp = new Date(host.collection_timestamp);
                return (!latest || timestamp > latest) ? timestamp : latest;
            }, null);

            if (latestTimestamp) {
                lastUpdateElement.textContent = formatTimestamp(latestTimestamp);
            } else {
                lastUpdateElement.textContent = 'Just now';
            }
        }
    </script>
</body>
</html>
